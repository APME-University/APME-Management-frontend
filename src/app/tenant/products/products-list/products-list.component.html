<div class="products-container">
  <p-toast></p-toast>
  <p-confirmDialog></p-confirmDialog>

  <!-- Header Section -->
  <div class="header-section">
    <div class="header-content">
      <div class="header-text">
        <h1 class="page-title">
          <span class="title-icon-wrapper">
            <i class="pi pi-box"></i>
          </span>
          <span class="title-text">Products Management</span>
        </h1>
        <p class="page-subtitle">
          Manage your product catalog, inventory, and pricing
        </p>
      </div>
    </div>

    <!-- Action Toolbar -->
    <div class="toolbar-section">
      <div class="toolbar-left">
        <p-button 
          [label]="'New Product'"
          icon="pi pi-plus" 
          (onClick)="openNew()"
          [rounded]="true"
          severity="primary"
          class="btn-primary">
        </p-button>
        <p-button 
          [label]="'Bulk Publish'"
          icon="pi pi-check-circle" 
          [disabled]="selectedProducts.length === 0"
          [rounded]="true"
          [text]="true"
          severity="success"
          class="btn-secondary"
          (onClick)="bulkPublish()">
        </p-button>
        <p-button 
          [label]="'Bulk Unpublish'"
          icon="pi pi-times-circle" 
          [disabled]="selectedProducts.length === 0"
          [rounded]="true"
          [text]="true"
          severity="warn"
          class="btn-secondary"
          (onClick)="bulkUnpublish()">
        </p-button>
        <div class="selection-badge" *ngIf="selectedProducts.length > 0">
          <i class="pi pi-check-circle badge-icon"></i>
          <span class="badge-text">{{ selectedProducts.length }} selected</span>
        </div>
      </div>
      <div class="toolbar-right">
        <div class="filter-group">
          <p-dropdown 
            [options]="statusFilterOptions" 
            [(ngModel)]="isActiveFilter"
            [placeholder]="'Status'"
            [showClear]="true"
            class="status-filter"
            (onChange)="onFilterChange()">
          </p-dropdown>
          <p-dropdown 
            [options]="publishedFilterOptions" 
            [(ngModel)]="isPublishedFilter"
            [placeholder]="'Published'"
            [showClear]="true"
            class="status-filter"
            (onChange)="onFilterChange()">
          </p-dropdown>
          <span class="p-input-icon-left search-wrapper">
            <i class="pi pi-search search-icon"></i>
            <input 
              pInputText 
              type="text" 
              [(ngModel)]="filterValue"
              (input)="onGlobalFilter($event)"
              [placeholder]="'Search products...'" 
              class="search-input" />
          </span>
          <p-button 
            icon="pi pi-filter-slash" 
            [label]="'Clear Filters'"
            [rounded]="true"
            [text]="true"
            severity="secondary"
            [disabled]="!hasActiveFilters()"
            (onClick)="clearAllFilters()"
            [pTooltip]="'Clear all filters'"
            tooltipPosition="top"
            class="clear-filters-btn">
          </p-button>
        </div>
      </div>
    </div>
  </div>

  <!-- Products Table Section -->
  <div class="table-section">
    <p-table 
      #dt 
      [value]="products" 
      [rows]="maxResultCount" 
      [totalRecords]="totalRecords"
      [loading]="loading"
      [paginator]="true" 
      [showCurrentPageReport]="true"
      [rowsPerPageOptions]="[10, 25, 50, 100]"
      [sortMode]="'single'"
      (onLazyLoad)="onPageChange($event)"
      (onSort)="onSort($event)"
      [currentPageReportTemplate]="'Showing {first} to {last} of {totalRecords} products'"
      responsiveLayout="scroll"
      [(selection)]="selectedProducts"
      [rowHover]="true"
      styleClass="products-datatable"
      [globalFilterFields]="['name', 'sku', 'slug', 'description']"
      [tableStyle]="{ 'min-width': '60rem' }">
      
      <ng-template pTemplate="header">
        <tr class="table-header-row">
          <th class="checkbox-column">
            <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
          </th>
          <th class="image-column">
            <span class="header-label">
              <i class="pi pi-image header-icon"></i>
              <span>Image</span>
            </span>
          </th>
          <th class="name-column" pSortableColumn="name">
            <span class="header-label">
              <span>Product</span>
              <p-sortIcon field="name"></p-sortIcon>
            </span>
          </th>
          <th class="sku-column" pSortableColumn="sku">
            <span class="header-label">
              <span>SKU</span>
              <p-sortIcon field="sku"></p-sortIcon>
            </span>
          </th>
          <th class="price-column" pSortableColumn="price">
            <span class="header-label">
              <span>Price</span>
              <p-sortIcon field="price"></p-sortIcon>
            </span>
          </th>
          <th class="stock-column">
            <span class="header-label">
              <i class="pi pi-box header-icon"></i>
              <span>Stock</span>
            </span>
          </th>
          <th class="status-column" pSortableColumn="isActive">
            <span class="header-label">
              <span>Status</span>
              <p-sortIcon field="isActive"></p-sortIcon>
            </span>
          </th>
          <th class="published-column" pSortableColumn="isPublished">
            <span class="header-label">
              <span>Published</span>
              <p-sortIcon field="isPublished"></p-sortIcon>
            </span>
          </th>
          <th class="actions-column">
            <span class="header-label">
              <i class="pi pi-cog header-icon"></i>
              <span>Actions</span>
            </span>
          </th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-product>
        <tr class="table-row">
          <td class="checkbox-cell">
            <p-tableCheckbox [value]="product"></p-tableCheckbox>
          </td>
          <td class="image-cell">
            <div class="product-image-container">
              <img 
                [src]="getImageUrl(product.primaryImageUrl)" 
                [alt]="product.name"
                class="product-image"
                (error)="onImageError($event)" />
              <div class="image-placeholder" *ngIf="!product.primaryImageUrl">
                <i class="pi pi-image"></i>
              </div>
              <div class="image-count-badge" *ngIf="product.imageCount && product.imageCount > 1">
                <i class="pi pi-images"></i>
                <span>{{ product.imageCount }}</span>
              </div>
            </div>
          </td>
          <td class="name-cell">
            <div class="name-content">
              <span class="name-text">{{ product.name }}</span>
              <span class="description-text" *ngIf="product.description">
                {{ product.description }}
              </span>
              <div class="price-row" *ngIf="product.isOnSale">
                <span class="price-original">{{ formatPrice(product.compareAtPrice!) }}</span>
                <span class="price-sale">{{ formatPrice(product.price) }}</span>
                <span class="sale-badge">Sale</span>
              </div>
            </div>
          </td>
          <td class="sku-cell">
            <code class="sku-code">{{ product.sku }}</code>
          </td>
          <td class="price-cell">
            <div class="price-content">
              <span class="price-main">{{ formatPrice(product.price) }}</span>
              <span class="price-compare" *ngIf="product.compareAtPrice">
                <s>{{ formatPrice(product.compareAtPrice) }}</s>
              </span>
            </div>
          </td>
          <td class="stock-cell">
            <div class="stock-indicator" [class]="getStockClass(product.stockQuantity)">
              <i [class]="getStockIcon(product.stockQuantity)"></i>
              <span>{{ product.stockQuantity }}</span>
            </div>
          </td>
          <td class="status-cell">
            <p-tag 
              [value]="product.isActive ? 'Active' : 'Inactive'" 
              [severity]="product.isActive ? 'success' : 'danger'"
              [rounded]="true"
              class="status-tag">
            </p-tag>
          </td>
          <td class="published-cell">
            <p-tag 
              [value]="product.isPublished ? 'Published' : 'Draft'" 
              [severity]="product.isPublished ? 'success' : 'warning'"
              [rounded]="true"
              class="status-tag">
            </p-tag>
          </td>
          <td class="actions-cell">
            <div class="action-buttons">
              <p-button 
                icon="pi pi-pencil" 
                [rounded]="true"
                [text]="true"
                [severity]="'info'"
                (onClick)="editProduct(product)"
                [pTooltip]="'Edit Product'"
                tooltipPosition="top"
                class="action-btn action-btn-edit">
              </p-button>
              <p-button 
                [icon]="product.isPublished ? 'pi pi-eye-slash' : 'pi pi-eye'" 
                [rounded]="true"
                [text]="true"
                [severity]="product.isPublished ? 'warn' : 'success'"
                (onClick)="togglePublished(product)"
                [pTooltip]="product.isPublished ? 'Unpublish' : 'Publish'"
                tooltipPosition="top"
                class="action-btn action-btn-toggle">
              </p-button>
              <p-button 
                icon="pi pi-trash" 
                [rounded]="true"
                [text]="true"
                [severity]="'danger'"
                (onClick)="confirmDeleteProduct(product)"
                [pTooltip]="'Delete Product'"
                tooltipPosition="top"
                class="action-btn action-btn-delete">
              </p-button>
            </div>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="9" class="empty-state-cell">
            <div class="empty-state">
              <div class="empty-state-icon-wrapper">
                <i class="pi pi-inbox empty-state-icon"></i>
              </div>
              <h3 class="empty-state-title">No Products Found</h3>
              <p class="empty-state-description">
                Start building your catalog by adding your first product
              </p>
              <p-button 
                [label]="'Create Product'"
                icon="pi pi-plus" 
                (onClick)="openNew()"
                [rounded]="true"
                class="empty-state-action">
              </p-button>
            </div>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="loadingbody">
        <tr>
          <td colspan="9" class="loading-cell">
            <div class="loading-wrapper">
              <p-progressSpinner 
                [style]="{width: '50px', height: '50px'}" 
                strokeWidth="4"
                class="loading-spinner">
              </p-progressSpinner>
              <p class="loading-text">Loading products...</p>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>

  <!-- Create/Update Dialog -->
  <app-create-update-product
    #createUpdateProduct
    [visible]="productDialog"
    [product]="product"
    [isEditMode]="isEditMode"
    (visibleChange)="hideDialog()"
    (save)="onProductSave($event)">
  </app-create-update-product>
</div>
