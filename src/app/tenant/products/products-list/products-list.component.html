<div class="products-container">
  <p-toast></p-toast>
  <p-confirmDialog></p-confirmDialog>

  <!-- Header Card -->
  <div class="header-card">
    <div class="flex items-center justify-between mb-6">
      <div>
        <h1 class="page-title">
          <i class="pi pi-box mr-3"></i>
          Products Management
        </h1>
        <p class="page-subtitle">Manage your product catalog, inventory, and pricing</p>
      </div>
    </div>

    <!-- Toolbar -->
    <p-toolbar styleClass="toolbar-custom">
      <ng-template pTemplate="left">
        <div class="flex gap-2 flex-wrap">
          <p-button 
            label="New Product" 
            icon="pi pi-plus" 
            (onClick)="openNew()"
            [rounded]="true"
            class="p-button-success">
          </p-button>
          <p-button 
            label="Bulk Publish" 
            icon="pi pi-check-circle" 
            [disabled]="selectedProducts.length === 0"
            [rounded]="true"
            [text]="true"
            (onClick)="bulkPublish()">
          </p-button>
          <p-button 
            label="Bulk Unpublish" 
            icon="pi pi-times-circle" 
            [disabled]="selectedProducts.length === 0"
            [rounded]="true"
            [text]="true"
            (onClick)="bulkUnpublish()">
          </p-button>
        </div>
      </ng-template>
      <ng-template pTemplate="right">
        <div class="flex gap-2 items-center flex-wrap">
          <p-dropdown 
            [options]="statusFilterOptions" 
            [(ngModel)]="isActiveFilter"
            placeholder="Status"
            [showClear]="true"
            styleClass="w-40"
            (onChange)="onFilterChange()">
          </p-dropdown>
          <p-dropdown 
            [options]="publishedFilterOptions" 
            [(ngModel)]="isPublishedFilter"
            placeholder="Published"
            [showClear]="true"
            styleClass="w-40"
            (onChange)="onFilterChange()">
          </p-dropdown>
          <span class="p-input-icon-left search-input-wrapper">
            <i class="pi pi-search"></i>
            <input 
              pInputText 
              type="text" 
              [value]="filterValue"
              (input)="onGlobalFilter($event)"
              placeholder="Search products..." 
              class="w-full" />
          </span>
        </div>
      </ng-template>
    </p-toolbar>
  </div>

  <!-- Products Table Card -->
  <div class="table-card">
    <p-table 
      #dt 
      [value]="products" 
      [rows]="maxResultCount" 
      [totalRecords]="totalRecords"
      [loading]="loading"
      [paginator]="true" 
      [showCurrentPageReport]="true"
      [rowsPerPageOptions]="[10, 25, 50, 100]"
      [sortMode]="'single'"
      (onLazyLoad)="onPageChange($event)"
      (onSort)="onSort($event)"
      currentPageReportTemplate="Showing {first} to {last} of {totalRecords} products"
      responsiveLayout="scroll"
      [(selection)]="selectedProducts"
      [rowHover]="true"
      styleClass="p-datatable-striped products-table"
      [globalFilterFields]="['name', 'sku', 'slug', 'description']">
      
      <ng-template pTemplate="header">
        <tr>
          <th style="width: 3rem">
            <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
          </th>
          <th style="min-width: 100px">Image</th>
          <th pSortableColumn="name" style="min-width: 250px">
            Product <p-sortIcon field="name"></p-sortIcon>
          </th>
          <th pSortableColumn="sku" style="min-width: 120px">
            SKU <p-sortIcon field="sku"></p-sortIcon>
          </th>
          <th pSortableColumn="price" style="min-width: 120px">
            Price <p-sortIcon field="price"></p-sortIcon>
          </th>
          <th style="min-width: 100px">Stock</th>
          <th pSortableColumn="isActive" style="min-width: 100px">
            Status <p-sortIcon field="isActive"></p-sortIcon>
          </th>
          <th pSortableColumn="isPublished" style="min-width: 120px">
            Published <p-sortIcon field="isPublished"></p-sortIcon>
          </th>
          <th style="min-width: 150px">Actions</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-product>
        <tr>
          <td>
            <p-tableCheckbox [value]="product"></p-tableCheckbox>
          </td>
          <td>
            <div class="product-image-wrapper">
              <img 
                [src]="getImageUrl(product.primaryImageUrl)" 
                [alt]="product.name"
                class="product-thumbnail"
                (error)="onImageError($event)" />
              <div class="image-overlay-badge" *ngIf="!product.primaryImageUrl">
                <i class="pi pi-image text-xs"></i>
              </div>
              <div class="image-count-badge" *ngIf="product.imageCount && product.imageCount > 1">
                <i class="pi pi-images text-xs"></i>
                <span>{{ product.imageCount }}</span>
              </div>
            </div>
          </td>
          <td>
            <div class="flex flex-col">
              <span class="font-semibold text-gray-900 dark:text-gray-100">{{ product.name }}</span>
              <span class="text-xs text-gray-500 dark:text-gray-400 line-clamp-2" *ngIf="product.description">
                {{ product.description }}
              </span>
              <div class="flex items-center gap-2 mt-1" *ngIf="product.isOnSale">
                <span class="price-original">{{ formatPrice(product.compareAtPrice!) }}</span>
                <span class="price-sale">{{ formatPrice(product.price) }}</span>
                <span class="sale-badge">Sale</span>
              </div>
            </div>
          </td>
          <td>
            <code class="sku-badge">{{ product.sku }}</code>
          </td>
          <td>
            <div class="flex flex-col">
              <span class="font-semibold text-gray-900 dark:text-gray-100">{{ formatPrice(product.price) }}</span>
              <span class="text-xs text-gray-500 dark:text-gray-400" *ngIf="product.compareAtPrice">
                <s>{{ formatPrice(product.compareAtPrice) }}</s>
              </span>
            </div>
          </td>
          <td>
            <div class="stock-indicator" [class]="getStockClass(product.stockQuantity)">
              <i [class]="getStockIcon(product.stockQuantity)"></i>
              <span>{{ product.stockQuantity }}</span>
            </div>
          </td>
          <td>
            <p-tag 
              [value]="product.isActive ? 'Active' : 'Inactive'" 
              [severity]="product.isActive ? 'success' : 'danger'"
              [rounded]="true">
            </p-tag>
          </td>
          <td>
            <p-tag 
              [value]="product.isPublished ? 'Published' : 'Draft'" 
              [severity]="product.isPublished ? 'success' : 'warning'"
              [rounded]="true">
            </p-tag>
          </td>
          <td>
            <div class="flex gap-1">
              <p-button 
                icon="pi pi-pencil" 
                [rounded]="true"
                [text]="true"
                [severity]="'info'"
                (onClick)="editProduct(product)"
                pTooltip="Edit Product"
                tooltipPosition="top"
                [style]="{'width': '2rem', 'height': '2rem'}">
              </p-button>
              <p-button 
                [icon]="product.isPublished ? 'pi pi-eye-slash' : 'pi pi-eye'" 
                [rounded]="true"
                [text]="true"
                [severity]="product.isPublished ? 'warn' : 'success'"
                (onClick)="togglePublished(product)"
                [pTooltip]="product.isPublished ? 'Unpublish' : 'Publish'"
                tooltipPosition="top"
                [style]="{'width': '2rem', 'height': '2rem'}">
              </p-button>
              <p-button 
                icon="pi pi-trash" 
                [rounded]="true"
                [text]="true"
                [severity]="'danger'"
                (onClick)="confirmDeleteProduct(product)"
                pTooltip="Delete Product"
                tooltipPosition="top"
                [style]="{'width': '2rem', 'height': '2rem'}">
              </p-button>
            </div>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="9" class="text-center py-12">
            <div class="empty-state">
              <div class="empty-state-icon">
                <i class="pi pi-inbox text-6xl text-gray-300 dark:text-gray-600"></i>
              </div>
              <h3 class="empty-state-title">No Products Found</h3>
              <p class="empty-state-message">Start building your catalog by adding your first product</p>
              <p-button 
                label="Create Product" 
                icon="pi pi-plus" 
                (onClick)="openNew()"
                [rounded]="true"
                class="mt-4">
              </p-button>
            </div>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="loadingbody">
        <tr>
          <td colspan="9">
            <div class="flex items-center justify-center py-8">
              <p-progressSpinner [style]="{width: '50px', height: '50px'}" strokeWidth="4"></p-progressSpinner>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>

  <!-- Create/Update Dialog -->
  <app-create-update-product
    #createUpdateProduct
    [visible]="productDialog"
    [(product)]="product"
    [(isEditMode)]="isEditMode"
    (visibleChange)="hideDialog()"
    (save)="onProductSave($event)">
  </app-create-update-product>
</div>

