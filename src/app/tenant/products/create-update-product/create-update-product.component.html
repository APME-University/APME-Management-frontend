<p-dialog 
  [(visible)]="visible" 
  [modal]="true" 
  [draggable]="false" 
  [resizable]="false"
  [closable]="true"
  [style]="{width: '90vw', maxWidth: '900px'}"
  styleClass="product-dialog"
  (onHide)="hideDialog()">
  
  <ng-template pTemplate="header">
    <div class="flex items-center gap-3 dialog-header">
      <i class="pi pi-box text-2xl text-primary"></i>
      <h5 class="m-0">{{ isEditMode ? 'Edit Product' : 'Create New Product' }}</h5>
    </div>
  </ng-template>

  <ng-template pTemplate="content">
    <form [formGroup]="productForm" (ngSubmit)="onSave()" class="product-form">
      <!-- Basic Information Section -->
      <div class="form-section">
        <h6 class="section-title">
          <i class="pi pi-info-circle mr-2"></i>
          Basic Information
        </h6>
        
        <!-- Name Field -->
        <div class="form-field">
          <label for="name" class="form-label">
            Name <span class="text-red-500">*</span>
          </label>
          <input 
            id="name"
            pInputText 
            formControlName="name"
            [class.ng-invalid]="isFieldInvalid('name')"
            placeholder="Enter product name"
            class="w-full"
            [maxlength]="256" />
          <small class="p-error" *ngIf="isFieldInvalid('name')">
            {{ getFieldError('name') }}
          </small>
        </div>

        <!-- Slug Field -->
        <div class="form-field">
          <div class="flex items-center justify-between mb-2">
            <label for="slug" class="form-label">
              Slug <span class="text-red-500">*</span>
            </label>
            <div class="flex items-center gap-2">
              <p-inputSwitch 
                [(ngModel)]="autoGenerateSlug" 
                [ngModelOptions]="{standalone: true}"
                (onChange)="toggleSlugAutoGeneration()">
              </p-inputSwitch>
              <small class="text-sm text-secondary">Auto-generate</small>
            </div>
          </div>
          <input 
            id="slug"
            pInputText 
            formControlName="slug"
            [class.ng-invalid]="isFieldInvalid('slug')"
            [readonly]="autoGenerateSlug"
            placeholder="product-slug"
            class="w-full"
            [maxlength]="256" />
          <small class="p-error" *ngIf="isFieldInvalid('slug')">
            {{ getFieldError('slug') }}
          </small>
        </div>

        <!-- SKU Field -->
        <div class="form-field">
          <div class="flex items-center justify-between mb-2">
            <label for="sku" class="form-label">
              SKU <span class="text-red-500">*</span>
            </label>
            <div class="flex items-center gap-2">
              <p-inputSwitch 
                [(ngModel)]="autoGenerateSku" 
                [ngModelOptions]="{standalone: true}"
                (onChange)="toggleSkuAutoGeneration()">
              </p-inputSwitch>
              <small class="text-sm text-secondary">Auto-generate</small>
            </div>
          </div>
          <input 
            id="sku"
            pInputText 
            formControlName="sku"
            [class.ng-invalid]="isFieldInvalid('sku')"
            [readonly]="autoGenerateSku"
            placeholder="PRODUCT-SKU"
            class="w-full"
            [maxlength]="128" />
          <small class="p-error" *ngIf="isFieldInvalid('sku')">
            {{ getFieldError('sku') }}
          </small>
        </div>

        <!-- Description Field -->
        <div class="form-field">
          <label for="description" class="form-label">Description</label>
          <textarea 
            id="description"
            pInputTextarea 
            formControlName="description"
            [class.ng-invalid]="isFieldInvalid('description')"
            placeholder="Enter product description"
            [rows]="4"
            [maxlength]="descriptionMaxLength"
            class="w-full">
          </textarea>
          <div class="flex justify-between items-center mt-1">
            <small class="p-error" *ngIf="isFieldInvalid('description')">
              {{ getFieldError('description') }}
            </small>
            <small class="text-sm text-secondary ml-auto">
              {{ descriptionLength }} / {{ descriptionMaxLength }} characters
            </small>
          </div>
        </div>

        <!-- Category Field -->
        <div class="form-field">
          <label for="categoryId" class="form-label">Category</label>
          <p-dropdown 
            id="categoryId"
            formControlName="categoryId"
            [options]="categories"
            optionLabel="name"
            optionValue="id"
            [showClear]="true"
            placeholder="Select category (optional)"
            [filter]="true"
            filterBy="name"
            class="w-full">
          </p-dropdown>
        </div>
      </div>

      <!-- Pricing Section -->
      <div class="form-section">
        <h6 class="section-title">
          <i class="pi pi-dollar mr-2"></i>
          Pricing & Inventory
        </h6>
        
        <!-- Price Field -->
        <div class="form-field">
          <label for="price" class="form-label">
            Price <span class="text-red-500">*</span>
          </label>
          <p-inputNumber 
            id="price"
            formControlName="price"
            [class.ng-invalid]="isFieldInvalid('price')"
            [min]="0"
            [maxFractionDigits]="2"
            [showButtons]="true"
            mode="currency"
            currency="USD"
            class="w-full">
          </p-inputNumber>
          <small class="p-error" *ngIf="isFieldInvalid('price')">
            {{ getFieldError('price') }}
          </small>
        </div>

        <!-- Compare At Price Field -->
        <div class="form-field">
          <label for="compareAtPrice" class="form-label">Compare At Price</label>
          <p-inputNumber 
            id="compareAtPrice"
            formControlName="compareAtPrice"
            [min]="0"
            [maxFractionDigits]="2"
            [showButtons]="true"
            mode="currency"
            currency="USD"
            class="w-full">
          </p-inputNumber>
          <small class="form-hint">
            Original price before discount (optional)
          </small>
        </div>
      </div>

        <!-- Stock Quantity Field -->
        <div class="form-field">
          <label for="stockQuantity" class="form-label">
            <i class="pi pi-box mr-1"></i>
            Stock Quantity <span class="text-red-500">*</span>
          </label>
          <p-inputNumber 
            id="stockQuantity"
            formControlName="stockQuantity"
            [class.ng-invalid]="isFieldInvalid('stockQuantity')"
            [min]="0"
            [showButtons]="true"
            class="w-full">
          </p-inputNumber>
          <small class="p-error" *ngIf="isFieldInvalid('stockQuantity')">
            {{ getFieldError('stockQuantity') }}
          </small>
          <small class="form-hint" *ngIf="!isFieldInvalid('stockQuantity')">
            Current available stock quantity
          </small>
        </div>

      <!-- Images Section -->
      <div class="form-section">
        <h6 class="section-title">
          <i class="pi pi-images mr-2"></i>
          Product Images
        </h6>
        
        <div class="image-upload-section">
          <p-fileUpload 
            mode="advanced"
            name="images[]"
            accept="image/*"
            [maxFileSize]="5242880"
            [multiple]="true"
            [auto]="false"
            chooseLabel="Select Images"
            chooseIcon="pi pi-upload"
            [showUploadButton]="false"
            [showCancelButton]="false"
            (onSelect)="onFileSelect($event)"
            styleClass="w-full">
          </p-fileUpload>

          <!-- Image Gallery Preview -->
          <div class="image-gallery-wrapper mt-4" *ngIf="imagePreviews.length > 0">
            <div class="gallery-header">
              <span class="gallery-count">
                <i class="pi pi-images mr-1"></i>
                {{ imagePreviews.length }} image(s) selected
              </span>
              <small class="gallery-hint">First image will be set as primary</small>
            </div>
            
            <div class="image-gallery">
              <div 
                class="image-item" 
                *ngFor="let preview of imagePreviews; let i = index"
                [class.primary]="i === 0">
                <div class="image-container">
                  <img [src]="preview" alt="Product image preview" class="gallery-image" />
                  <div class="image-overlay">
                    <div class="image-actions">
                      <p-button 
                        icon="pi pi-star" 
                        [rounded]="true"
                        [text]="true"
                        [severity]="i === 0 ? 'warn' : undefined"
                        (onClick)="setPrimaryImage(i)"
                        [pTooltip]="i === 0 ? 'Primary Image' : 'Set as Primary'"
                        tooltipPosition="top"
                        [style]="{'width': '2rem', 'height': '2rem'}"
                        [disabled]="i === 0">
                      </p-button>
                      <p-button 
                        icon="pi pi-times" 
                        [rounded]="true"
                        [text]="true"
                        [severity]="'danger'"
                        (onClick)="removeImage(i)"
                        pTooltip="Remove image"
                        tooltipPosition="top"
                        [style]="{'width': '2rem', 'height': '2rem'}">
                      </p-button>
                    </div>
                  </div>
                  <div class="image-badge" *ngIf="i === 0">
                    <i class="pi pi-star-fill"></i>
                    Primary
                  </div>
                  <div class="image-index">{{ i + 1 }}</div>
                </div>
              </div>
            </div>
          </div>

          <small class="form-hint mt-2 block">
            <i class="pi pi-info-circle mr-1"></i>
            Supported formats: JPG, PNG, WebP, GIF. Maximum file size: 5MB per image. You can select multiple images.
          </small>
        </div>
      </div>

      <!-- Publishing Section -->
      <div class="form-section">
        <h6 class="section-title">
          <i class="pi pi-globe mr-2"></i>
          Publishing & Status
        </h6>
        
        <!-- Is Active Toggle -->
        <div class="form-field">
          <div class="flex items-center justify-between">
            <div>
              <label for="isActive" class="form-label">Active Status</label>
              <p class="form-hint m-0">Enable or disable the product</p>
            </div>
            <p-inputSwitch 
              id="isActive"
              formControlName="isActive"
              [style]="{transform: 'scale(1.2)'}">
            </p-inputSwitch>
          </div>
        </div>

        <!-- Is Published Toggle -->
        <div class="form-field">
          <div class="flex items-center justify-between">
            <div>
              <label for="isPublished" class="form-label">Published Status</label>
              <p class="form-hint m-0">Make product visible to customers</p>
            </div>
            <p-inputSwitch 
              id="isPublished"
              formControlName="isPublished"
              [style]="{transform: 'scale(1.2)'}">
            </p-inputSwitch>
          </div>
        </div>
      </div>
    </form>
  </ng-template>

  <ng-template pTemplate="footer">
    <div class="flex justify-end gap-2">
      <p-button 
        label="Cancel" 
        icon="pi pi-times" 
        [text]="true"
        (onClick)="hideDialog()"
        [disabled]="loading || uploadingImages">
      </p-button>
      <p-button 
        label="{{ isEditMode ? 'Update' : 'Create' }}" 
        icon="pi pi-check" 
        (onClick)="onSave()"
        [loading]="loading || uploadingImages"
        [disabled]="productForm.invalid">
      </p-button>
    </div>
  </ng-template>
</p-dialog>

